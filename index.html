<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½æˆ¶è»Šè™Ÿç®¡ç†ç³»çµ± - è¦–è¦ºæ¸¬é©—ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        * { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .quiz-option {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .quiz-option:active { transform: scale(0.98); }
        .quiz-image-container {
            width: 100%;
            height: 200px;
            background: #f1f5f9;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<div id="app" class="max-w-4xl mx-auto px-4 py-8 pb-24">
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-slate-800">ä½æˆ¶è»Šè™Ÿç®¡ç†ç³»çµ±</h1>
        <p class="text-slate-500 mt-2">é€²éšè¦–è¦ºæ¸¬é©—ç‰ˆ</p>
    </header>

    <nav class="flex justify-center space-x-4 md:space-x-8 mb-8 border-b border-slate-200 overflow-x-auto hide-scrollbar whitespace-nowrap text-sm md:text-base">
        <button onclick="window.switchTab('search')" id="tab-search" class="pb-2 px-2 md:px-4 font-medium transition-all tab-active">è»Šè™ŸæŸ¥è©¢</button>
        <button onclick="window.switchTab('quiz')" id="tab-quiz" class="pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500">éš¨æ©Ÿæ¸¬é©—</button>
        <button onclick="window.switchTab('manage')" id="tab-manage" class="pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500">è»Šè¼›ç®¡ç†</button>
        <button onclick="window.switchTab('data')" id="tab-data" class="pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500">è³‡æ–™å°å…¥</button>
    </nav>

    <!-- æœå°‹å€å¡Š (ç¶­æŒåŸæ¨£) -->
    <section id="section-search" class="space-y-6">
        <div class="glass-morphism p-6 rounded-2xl shadow-sm border border-slate-200">
            <input type="text" id="search-input" placeholder="è¼¸å…¥è»Šè™Ÿæˆ–è»Šä½æœå°‹..." 
                class="w-full pl-4 pr-4 py-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-lg shadow-inner">
        </div>
        <div id="result-container" class="hidden animate-in fade-in">
             <!-- æœå°‹çµæœé¡¯ç¤ºå€ -->
             <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100" id="search-result-box"></div>
        </div>
    </section>

    <!-- éš¨æ©Ÿæ¸¬é©—å€å¡Š (æ–°å¢è¦–è¦ºåŒ–åŠŸèƒ½) -->
    <section id="section-quiz" class="hidden space-y-6">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-slate-800">éš¨æ©Ÿè¦–è¦ºæ¸¬é©—</h3>
                    <p class="text-slate-400 text-sm">è¾¨è­˜ç…§ç‰‡ã€è»Šä½æˆ–è»Šè¼›ç‰¹å¾µ</p>
                </div>
                <div class="bg-blue-50 px-4 py-2 rounded-full">
                    <span id="quiz-score" class="text-blue-600 font-bold">æº–ç¢ºç‡: --%</span>
                </div>
            </div>
            
            <!-- é¡Œç›®é¡¯ç¤ºå€ -->
            <div id="quiz-content" class="space-y-6">
                <div id="quiz-question-card" class="bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200 text-center">
                    <div id="quiz-type-tag" class="inline-block px-3 py-1 bg-slate-800 text-white text-[10px] font-bold rounded-full mb-4 uppercase tracking-widest">æ¨¡å¼è¼‰å…¥ä¸­</div>
                    
                    <!-- é¡Œç›®ä¸»é«” -->
                    <div id="quiz-visual-area" class="mb-4">
                        <!-- å¯èƒ½æ˜¯åœ–ç‰‡ã€å¯èƒ½æ˜¯æ–‡å­—è»Šä½ã€å¯èƒ½æ˜¯ç‰¹å¾µ -->
                    </div>
                </div>

                <!-- é¸é …å€ -->
                <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                <!-- å›é¥‹å€ -->
                <div id="quiz-feedback-box" class="hidden text-center animate-bounce-in">
                    <div id="quiz-result-msg" class="text-xl font-black mb-4"></div>
                    <button onclick="window.generateQuiz()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg hover:bg-blue-700">ä¸‹ä¸€é¡Œ</button>
                </div>
            </div>

            <!-- ç„¡è³‡æ–™ç‹€æ…‹ -->
            <div id="quiz-empty" class="hidden py-20 text-center text-slate-400">
                <p>è³‡æ–™åº«è»Šè¼›ä¸è¶³ï¼ˆè‡³å°‘éœ€è¦ 4 è¼›ï¼‰ï¼Œè«‹å…ˆå°å…¥è³‡æ–™ã€‚</p>
            </div>
        </div>
    </section>

    <!-- ç®¡ç†èˆ‡å°å…¥å€å¡Š (ç¶­æŒåŸæ¨£ï¼Œåƒ…ç°¡åŒ–é¡¯ç¤º) -->
    <section id="section-manage" class="hidden space-y-4">
        <div id="manage-list-container"></div>
    </section>
    
    <section id="section-data" class="hidden">
        <div class="bg-white p-6 rounded-2xl border">
            <textarea id="raw-html-input" rows="5" class="w-full p-4 border rounded-xl text-xs mb-4" placeholder="è²¼ä¸Šè³‡æ–™..."></textarea>
            <button onclick="window.importDataFromHTML()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold">å°å…¥è³‡æ–™</button>
        </div>
    </section>
</div>

<script>
    let carData = JSON.parse(localStorage.getItem('local_car_db') || '[]');
    let currentQuiz = { answer: null, stats: { total: 0, correct: 0 } };

    window.switchTab = (tab) => {
        ['search', 'quiz', 'manage', 'data'].forEach(s => {
            document.getElementById(`section-${s}`).classList.add('hidden');
            document.getElementById(`tab-${s}`).className = "pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500";
        });
        document.getElementById(`section-${tab}`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).className = "pb-2 px-2 md:px-4 font-medium transition-all tab-active";
        if(tab === 'quiz') window.generateQuiz();
    };

    // æ ¸å¿ƒæ¸¬é©—ç”¢ç”Ÿå™¨
    window.generateQuiz = () => {
        const quizContent = document.getElementById('quiz-content');
        const quizEmpty = document.getElementById('quiz-empty');
        const optionsContainer = document.getElementById('quiz-options');
        const visualArea = document.getElementById('quiz-visual-area');
        const typeTag = document.getElementById('quiz-type-tag');
        const feedbackBox = document.getElementById('quiz-feedback-box');

        feedbackBox.classList.add('hidden');
        optionsContainer.innerHTML = '';
        
        if (carData.length < 4) {
            quizContent.classList.add('hidden');
            quizEmpty.classList.remove('hidden');
            return;
        }

        quizContent.classList.remove('hidden');
        quizEmpty.classList.add('hidden');

        // éš¨æ©Ÿé¸ä¸€å€‹ç›®æ¨™
        const target = carData[Math.floor(Math.random() * carData.length)];
        currentQuiz.answer = target.plate;

        // éš¨æ©Ÿæ±ºå®šæ¸¬é©—æ¨¡å¼: 0:ç…§ç‰‡(å¦‚æœæœ‰), 1:ç‰¹å¾µ, 2:è»Šä½
        let mode = Math.floor(Math.random() * 3);
        if (mode === 0 && !target.photoBase64) mode = 1; // æ²’ç…§ç‰‡å°±æ”¹æ¸¬ç‰¹å¾µ

        if (mode === 0) {
            typeTag.innerText = "è¦–è¦ºè¾¨è­˜ï¼šé€™æ˜¯å“ªå°è»Šï¼Ÿ";
            visualArea.innerHTML = `
                <div class="quiz-image-container shadow-inner">
                    <img src="${target.photoBase64}" class="w-full h-full object-cover">
                </div>
            `;
        } else if (mode === 1) {
            typeTag.innerText = "ç‰¹å¾µè¾¨è­˜ï¼šå“ªå°è»Šç¬¦åˆæè¿°ï¼Ÿ";
            visualArea.innerHTML = `
                <div class="py-4">
                    <div class="text-sm text-slate-400 font-bold mb-1">è»Šè¼›æè¿°</div>
                    <div class="text-3xl font-black text-slate-800">${target.color || 'ä¸è©³'}è‰² ${target.brand || 'æœªçŸ¥å“ç‰Œ'}</div>
                </div>
            `;
        } else {
            typeTag.innerText = "ä½ç½®è¾¨è­˜ï¼šæ­¤è»Šä½çš„è»Šç‰Œæ˜¯ï¼Ÿ";
            visualArea.innerHTML = `
                <div class="py-4">
                    <div class="text-sm text-slate-400 font-bold mb-1">è»Šä½è™Ÿç¢¼</div>
                    <div class="text-5xl font-black text-blue-600 tracking-tighter">${target.spot || 'ç„¡ç·¨è™Ÿ'}</div>
                </div>
            `;
        }

        // ç”¢ç”Ÿé¸é …
        let options = [target.plate];
        while (options.length < 4) {
            const randomPlate = carData[Math.floor(Math.random() * carData.length)].plate;
            if (!options.includes(randomPlate)) options.push(randomPlate);
        }
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "quiz-option p-5 bg-white border-2 border-slate-100 rounded-2xl text-lg font-bold text-slate-700 hover:border-blue-400 hover:bg-blue-50 shadow-sm";
            btn.innerText = opt;
            btn.onclick = () => window.checkAnswer(opt, btn);
            optionsContainer.appendChild(btn);
        });
    };

    window.checkAnswer = (selected, btn) => {
        const feedbackBox = document.getElementById('quiz-feedback-box');
        const resultMsg = document.getElementById('quiz-result-msg');
        const allBtns = document.querySelectorAll('.quiz-option');
        
        allBtns.forEach(b => b.disabled = true);
        currentQuiz.stats.total++;

        if (selected === currentQuiz.answer) {
            currentQuiz.stats.correct++;
            btn.className = "quiz-option p-5 bg-green-500 border-2 border-green-600 rounded-2xl text-lg font-bold text-white shadow-lg scale-105 transition-all";
            resultMsg.innerText = "ğŸ¯ å¤ªæ£’äº†ï¼Œå®Œå…¨æ­£ç¢ºï¼";
            resultMsg.className = "text-xl font-black mb-4 text-green-600";
        } else {
            btn.className = "quiz-option p-5 bg-red-500 border-2 border-red-600 rounded-2xl text-lg font-bold text-white shadow-lg transition-all";
            resultMsg.innerText = `âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºæ˜¯ï¼š${currentQuiz.answer}`;
            resultMsg.className = "text-xl font-black mb-4 text-red-600";
            
            // æ¨™ç¤ºå‡ºæ­£ç¢ºç­”æ¡ˆ
            allBtns.forEach(b => {
                if(b.innerText === currentQuiz.answer) b.classList.add('border-green-500', 'text-green-600', 'bg-green-50');
            });
        }

        const percent = Math.round((currentQuiz.stats.correct / currentQuiz.stats.total) * 100);
        document.getElementById('quiz-score').innerText = `æº–ç¢ºç‡: ${percent}%`;
        feedbackBox.classList.remove('hidden');
    };

    // åŸºç¤åŠŸèƒ½ (ç°¡åŒ–å°å…¥èˆ‡æœå°‹)
    window.importDataFromHTML = () => {
        const input = document.getElementById('raw-html-input').value;
        const parser = new DOMParser();
        const doc = parser.parseFromString(input, 'text/html');
        const rows = doc.querySelectorAll('tr');
        let batch = [];
        rows.forEach(r => {
            const tds = r.querySelectorAll('td');
            if(tds.length >= 6 && tds[1].innerText.trim() !== "è»Šè™Ÿ") {
                batch.push({
                    id: tds[0].innerText.trim(),
                    plate: tds[1].innerText.trim().toUpperCase(),
                    brand: tds[2].innerText.trim(),
                    color: tds[3].innerText.trim(),
                    floor: tds[4].innerText.trim().toUpperCase(),
                    spot: tds[5].innerText.trim().toUpperCase(),
                    photoBase64: null
                });
            }
        });
        if(batch.length > 0) {
            carData = batch;
            localStorage.setItem('local_car_db', JSON.stringify(carData));
            alert(`å°å…¥æˆåŠŸ ${batch.length} ç­†`);
        }
    };

    // æœå°‹é‚è¼¯
    document.getElementById('search-input').addEventListener('input', (e) => {
        const val = e.target.value.toUpperCase().trim();
        const container = document.getElementById('result-container');
        const box = document.getElementById('search-result-box');
        if (!val) { container.classList.add('hidden'); return; }
        const found = carData.find(c => c.plate.includes(val) || (c.spot && c.spot.includes(val)));
        if (found) {
            box.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-4xl font-black text-blue-600">${found.plate}</div>
                        <div class="text-slate-500 font-bold">${found.floor} - ${found.spot}</div>
                    </div>
                    ${found.photoBase64 ? `<img src="${found.photoBase64}" class="w-20 h-20 rounded-xl object-cover border">` : '<div class="w-20 h-20 bg-slate-100 rounded-xl border flex items-center justify-center text-[10px] text-slate-400">ç„¡ç…§ç‰‡</div>'}
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="p-2 bg-slate-50 rounded-lg text-sm">å» ç‰Œ: ${found.brand}</div>
                    <div class="p-2 bg-slate-50 rounded-lg text-sm">é¡è‰²: ${found.color}</div>
                </div>
            `;
            container.classList.remove('hidden');
        } else { container.classList.add('hidden'); }
    });
</script>
</body>
</html>
