<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住戶車號管理系統 - 智慧解析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-morphism { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .quiz-option { transition: all 0.2s; border: 2px solid transparent; }
        .quiz-option:active { transform: scale(0.98); }
        .correct-anim { animation: pulse 0.5s ease-in-out; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<div id="app" class="max-w-4xl mx-auto px-4 py-8 pb-24">
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-slate-800">住戶車號管理系統</h1>
        <p class="text-slate-500 text-sm mt-1">智慧對齊解析模式</p>
    </header>

    <nav class="flex justify-center space-x-4 mb-8 border-b border-slate-200 overflow-x-auto hide-scrollbar whitespace-nowrap">
        <button onclick="window.switchTab('search')" id="tab-search" class="pb-2 px-4 font-medium tab-active">車號查詢</button>
        <button onclick="window.switchTab('quiz')" id="tab-quiz" class="pb-2 px-4 font-medium text-slate-500">視覺測驗</button>
        <button onclick="window.switchTab('manage')" id="tab-manage" class="pb-2 px-4 font-medium text-slate-500">車輛管理</button>
        <button onclick="window.switchTab('data')" id="tab-data" class="pb-2 px-4 font-medium text-slate-500">智慧導入</button>
    </nav>

    <!-- 查詢分頁 -->
    <section id="section-search">
        <div class="glass-morphism p-6 rounded-2xl shadow-sm border border-slate-200">
            <input type="text" id="search-input" placeholder="輸入車號或車位搜尋..." class="w-full px-4 py-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-lg">
        </div>
        <div id="result-container" class="hidden mt-6 animate-in fade-in">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex flex-col md:flex-row gap-6">
                <div class="flex-1 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 id="res-plate" class="text-4xl font-black text-blue-600"></h2>
                        <span id="res-floor" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-slate-50 rounded-xl"><p class="text-xs text-slate-400 font-bold">品牌</p><p id="res-brand" class="text-lg font-semibold"></p></div>
                        <div class="p-3 bg-slate-50 rounded-xl"><p class="text-xs text-slate-400 font-bold">顏色</p><p id="res-color" class="text-lg font-semibold"></p></div>
                        <div class="p-3 bg-slate-50 rounded-xl"><p class="text-xs text-slate-400 font-bold">車位</p><p id="res-spot" class="text-lg font-semibold text-blue-600"></p></div>
                        <div class="p-3 bg-slate-50 rounded-xl"><p class="text-xs text-slate-400 font-bold">住戶</p><p id="res-id" class="text-lg font-semibold"></p></div>
                    </div>
                </div>
                <div id="photo-display" class="w-full md:w-48 aspect-square bg-slate-100 rounded-xl overflow-hidden border flex items-center justify-center">
                    <img id="car-img" class="w-full h-full object-cover hidden">
                    <span class="text-slate-400 text-sm">無照片</span>
                </div>
            </div>
        </div>
        <div id="no-result" class="hidden text-center py-12 text-slate-400">找不到資料。</div>
    </section>

    <!-- 測驗分頁 -->
    <section id="section-quiz" class="hidden">
        <div class="bg-white p-6 rounded-3xl shadow-xl border text-center relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-slate-100"><div id="quiz-progress-bar" class="h-full bg-blue-500" style="width: 0%"></div></div>
            <div class="flex justify-between items-center mb-6 pt-2">
                <span class="text-xs font-bold text-slate-400">視覺記憶測驗</span>
                <div class="bg-slate-100 px-3 py-1 rounded-full text-sm">
                    <span class="text-blue-600 font-black" id="quiz-score">0</span>
                    <span class="text-slate-400 mx-1">/</span>
                    <span id="quiz-total-target" class="font-bold">0</span>
                </div>
            </div>
            <div id="quiz-q-box" class="mb-8">
                <div class="w-48 h-48 bg-slate-50 mx-auto rounded-2xl mb-4 overflow-hidden border-2 border-white shadow-lg">
                    <img id="quiz-q-img" class="w-full h-full object-cover hidden">
                    <div id="quiz-q-noimg" class="h-full flex items-center justify-center text-slate-300">無照片</div>
                </div>
                <div id="quiz-q-plate" class="text-5xl font-black text-slate-800">---</div>
                <div id="quiz-q-info" class="text-slate-400 text-sm mt-2">---</div>
            </div>
            <div id="quiz-options" class="grid grid-cols-2 gap-4"></div>
            <div id="quiz-feedback-box" class="hidden mt-6">
                <div id="quiz-feedback" class="p-4 rounded-xl font-bold mb-4"></div>
                <button onclick="window.generateQuiz()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold">下一題</button>
            </div>
            <div id="quiz-empty" class="hidden py-12 text-slate-400 italic">請先導入至少 4 筆有車位的資料。</div>
        </div>
    </section>

    <!-- 管理分頁 -->
    <section id="section-manage" class="hidden space-y-4">
        <div class="flex justify-between items-center">
            <h3 class="font-bold">車輛清單 (<span id="manage-count">0</span>)</h3>
            <button onclick="window.openEditModal(null)" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg">新增</button>
        </div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 border-b text-slate-400 font-bold">
                    <tr><th class="p-3">車牌</th><th class="p-3">車位</th><th class="p-3">資訊</th><th class="p-3 text-right">操作</th></tr>
                </thead>
                <tbody id="manage-list" class="divide-y"></tbody>
            </table>
        </div>
    </section>

    <!-- 導入分頁 -->
    <section id="section-data" class="hidden space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border">
            <h3 class="font-bold mb-2">智慧資料解析器</h3>
            <p class="text-xs text-slate-500 mb-4">直接貼上您剛才那種「車位、車牌、品牌分開」的文字，系統會自動對齊。</p>
            <textarea id="raw-input" rows="10" class="w-full p-4 border rounded-xl font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none" placeholder="將亂掉的文字貼在此處..."></textarea>
            <div class="flex gap-4 mt-4">
                <button onclick="window.smartImport()" class="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold">開始智慧解析</button>
                <button onclick="window.clearData()" class="px-6 py-4 bg-red-50 text-red-600 rounded-xl font-bold">清空</button>
            </div>
        </div>
    </section>

    <!-- 編輯彈窗 -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-3xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 id="modal-title" class="text-xl font-bold">車輛資訊</h3><button onclick="window.closeEditModal()">✕</button></div>
            <div class="space-y-4">
                <div class="flex flex-col items-center">
                    <div class="w-32 h-32 bg-slate-50 rounded-2xl border flex items-center justify-center relative overflow-hidden">
                        <img id="modal-preview-img" class="absolute inset-0 w-full h-full object-cover hidden">
                        <span class="text-[10px] text-slate-400">預覽</span>
                    </div>
                    <input type="file" accept="image/*" id="file-input" class="hidden" onchange="window.previewImage(event)">
                    <button onclick="document.getElementById('file-input').click()" class="mt-2 text-xs bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-600">更換照片</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="edit-plate" placeholder="車牌" class="p-3 bg-slate-50 rounded-xl border">
                    <input type="text" id="edit-spot" placeholder="車位" class="p-3 bg-slate-50 rounded-xl border">
                    <input type="text" id="edit-brand" placeholder="品牌" class="p-3 bg-slate-50 rounded-xl border">
                    <input type="text" id="edit-color" placeholder="顏色" class="p-3 bg-slate-50 rounded-xl border">
                    <input type="text" id="edit-floor" placeholder="樓層" class="p-3 bg-slate-50 rounded-xl border">
                    <input type="text" id="edit-id" placeholder="住戶編號" class="p-3 bg-slate-50 rounded-xl border">
                </div>
                <div class="flex gap-4 pt-4">
                    <button onclick="window.deleteCar()" id="delete-btn" class="px-6 py-3 text-red-500 font-bold">刪除</button>
                    <button onclick="window.saveCar()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">儲存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let carData = JSON.parse(localStorage.getItem('car_db_v2') || '[]');
    let currentEditPlate = null;
    let currentImgBase64 = null;
    let quizState = { score: 0, answered: [], currentTarget: null };

    window.switchTab = (tab) => {
        ['search', 'quiz', 'manage', 'data'].forEach(t => {
            document.getElementById(`section-${t}`).classList.add('hidden');
            document.getElementById(`tab-${t}`).className = "pb-2 px-4 font-medium text-slate-500";
        });
        document.getElementById(`section-${tab}`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).className = "pb-2 px-4 font-medium tab-active";
        if(tab === 'manage') renderManage();
        if(tab === 'quiz') resetQuiz();
    };

    // --- 核心：智慧解析器 ---
    window.smartImport = () => {
        const input = document.getElementById('raw-input').value;
        if(!input) return;

        // 1. 提取所有車位號碼 (3位或4位純數字)
        const spots = input.match(/\b\d{3}\b/g) || [];
        
        // 2. 提取所有車牌 (格式如 ABC-1234, 1234-AB, 5218-QU 等)
        // 匹配規則：包含連字號的英數組合，或特定的車牌格式
        const plates = input.match(/[A-Z0-9]{2,4}-[A-Z0-9]{2,4}/g) || [];

        // 3. 提取品牌顏色資訊 (尋找包含 LEXUS, bmw, benz 等關鍵字或特定結構的行)
        // 由於品牌資訊通常連著「LEXUS 灰 b2」，我們用正則抓取
        const infoLines = input.match(/(LEXUS|bmw|benz|toyota|ford|porshe|MINI|INFINITI|bently|LAMBO|NISAN|MASA|volvo|MARTIN|HONDA|MAZDA|ROVER|TESLA|AUDI|福斯)[^\n]+/gi) || [];

        // 4. 提取住戶編號 (如 24A, 19C, 30CD 等)
        const residentIds = input.match(/\b\d{1,2}[A-D]{1,2}\b/g) || [];

        // 對齊邏輯：以「車牌」為核心
        let newBatch = [];
        plates.forEach((plate, index) => {
            const info = infoLines[index] || "";
            const infoParts = info.split(/\s+/); // 分割 "LEXUS 灰 b2"
            
            newBatch.push({
                plate: plate,
                spot: spots[index] || "",
                brand: infoParts[0] || "",
                color: infoParts[1] || "",
                floor: infoParts[2] || "",
                id: residentIds[index] || "",
                photoBase64: null
            });
        });

        if(newBatch.length > 0) {
            carData = newBatch;
            localStorage.setItem('car_db_v2', JSON.stringify(carData));
            alert(`智慧解析成功！已對齊 ${newBatch.length} 台車輛。`);
            window.switchTab('manage');
        } else {
            alert("解析失敗，請確認內容包含車牌與車位資訊。");
        }
    };

    // --- 測驗功能 ---
    function resetQuiz() {
        quizState.score = 0;
        quizState.answered = [];
        const pool = carData.filter(c => c.spot && c.plate);
        document.getElementById('quiz-total-target').innerText = pool.length;
        window.generateQuiz();
    }

    window.generateQuiz = () => {
        const pool = carData.filter(c => c.spot && c.plate);
        const qBox = document.getElementById('quiz-q-box');
        const empty = document.getElementById('quiz-empty');
        const options = document.getElementById('quiz-options');
        const feedbackBox = document.getElementById('quiz-feedback-box');

        if(pool.length < 4) { qBox.classList.add('hidden'); options.innerHTML=''; empty.classList.remove('hidden'); return; }
        
        empty.classList.add('hidden');
        qBox.classList.remove('hidden');
        feedbackBox.classList.add('hidden');
        options.innerHTML = '';

        let available = pool.filter(c => !quizState.answered.includes(c.plate));
        if(available.length === 0) { quizState.answered = []; available = pool; }

        const target = available[Math.floor(Math.random() * available.length)];
        quizState.currentTarget = target;

        document.getElementById('quiz-q-plate').innerText = target.plate;
        document.getElementById('quiz-q-info').innerText = `${target.brand} ${target.color} (${target.floor})`;
        
        const qImg = document.getElementById('quiz-q-img');
        const qNoImg = document.getElementById('quiz-q-noimg');
        if(target.photoBase64) { qImg.src = target.photoBase64; qImg.classList.remove('hidden'); qNoImg.classList.add('hidden'); }
        else { qImg.classList.add('hidden'); qNoImg.classList.remove('hidden'); }

        let opts = [target.spot];
        while(opts.length < 4) {
            const r = pool[Math.floor(Math.random() * pool.length)].spot;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'quiz-option p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl text-xl font-black text-slate-700';
            btn.innerText = opt;
            btn.onclick = () => checkQuiz(opt, btn);
            options.appendChild(btn);
        });
    };

    function checkQuiz(selected, btn) {
        const allBtns = document.querySelectorAll('.quiz-option');
        const feedback = document.getElementById('quiz-feedback');
        const scoreEl = document.getElementById('quiz-score');
        allBtns.forEach(b => b.disabled = true);

        if(selected === quizState.currentTarget.spot) {
            btn.classList.add('bg-green-500', 'text-white', 'correct-anim');
            quizState.score++;
            quizState.answered.push(quizState.currentTarget.plate);
            feedback.innerText = "正確！";
            feedback.className = "p-4 rounded-xl font-bold mb-4 bg-green-50 text-green-700";
        } else {
            btn.classList.add('bg-red-500', 'text-white');
            feedback.innerText = `錯誤，正確答案是 ${quizState.currentTarget.spot}`;
            feedback.className = "p-4 rounded-xl font-bold mb-4 bg-red-50 text-red-700";
        }
        
        scoreEl.innerText = quizState.score;
        const progress = (quizState.answered.length / carData.filter(c=>c.spot).length) * 100;
        document.getElementById('quiz-progress-bar').style.width = `${progress}%`;
        document.getElementById('quiz-feedback-box').classList.remove('hidden');
    }

    // --- 管理與編輯 ---
    function renderManage() {
        const list = document.getElementById('manage-list');
        document.getElementById('manage-count').innerText = carData.length;
        list.innerHTML = carData.map(c => `
            <tr>
                <td class="p-3 font-bold">${c.plate}</td>
                <td class="p-3 text-blue-600 font-bold">${c.spot}</td>
                <td class="p-3 text-xs text-slate-400">${c.brand} ${c.color}</td>
                <td class="p-3 text-right"><button onclick="window.openEditModal('${c.plate}')" class="text-blue-500">編輯</button></td>
            </tr>
        `).join('');
    }

    window.openEditModal = (plate) => {
        currentEditPlate = plate;
        currentImgBase64 = null;
        if(plate) {
            const c = carData.find(x => x.plate === plate);
            document.getElementById('edit-plate').value = c.plate;
            document.getElementById('edit-spot').value = c.spot;
            document.getElementById('edit-brand').value = c.brand;
            document.getElementById('edit-color').value = c.color;
            document.getElementById('edit-floor').value = c.floor;
            document.getElementById('edit-id').value = c.id;
            if(c.photoBase64) {
                document.getElementById('modal-preview-img').src = c.photoBase64;
                document.getElementById('modal-preview-img').classList.remove('hidden');
                currentImgBase64 = c.photoBase64;
            } else {
                document.getElementById('modal-preview-img').classList.add('hidden');
            }
        } else {
            ['plate','spot','brand','color','floor','id'].forEach(f => document.getElementById(`edit-${f}`).value = '');
            document.getElementById('modal-preview-img').classList.add('hidden');
        }
        document.getElementById('edit-modal').classList.remove('hidden');
    };

    window.saveCar = () => {
        const plate = document.getElementById('edit-plate').value.toUpperCase().trim();
        const obj = {
            plate,
            spot: document.getElementById('edit-spot').value,
            brand: document.getElementById('edit-brand').value,
            color: document.getElementById('edit-color').value,
            floor: document.getElementById('edit-floor').value,
            id: document.getElementById('edit-id').value,
            photoBase64: currentImgBase64
        };
        if(currentEditPlate) {
            const i = carData.findIndex(x => x.plate === currentEditPlate);
            carData[i] = obj;
        } else {
            carData.push(obj);
        }
        localStorage.setItem('car_db_v2', JSON.stringify(carData));
        document.getElementById('edit-modal').classList.add('hidden');
        renderManage();
    };

    window.previewImage = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400; canvas.height = 400;
                ctx.drawImage(img, 0, 0, 400, 400);
                currentImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('modal-preview-img').src = currentImgBase64;
                document.getElementById('modal-preview-img').classList.remove('hidden');
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    // 搜尋功能
    document.getElementById('search-input').addEventListener('input', (e) => {
        const v = e.target.value.toUpperCase();
        const res = document.getElementById('result-container');
        const no = document.getElementById('no-result');
        if(!v) { res.classList.add('hidden'); return; }
        const f = carData.find(c => c.plate.includes(v) || c.spot.includes(v));
        if(f) {
            document.getElementById('res-plate').innerText = f.plate;
            document.getElementById('res-brand').innerText = f.brand;
            document.getElementById('res-color').innerText = f.color;
            document.getElementById('res-spot').innerText = f.spot;
            document.getElementById('res-floor').innerText = f.floor;
            document.getElementById('res-id').innerText = f.id;
            const img = document.getElementById('car-img');
            if(f.photoBase64) { img.src = f.photoBase64; img.classList.remove('hidden'); }
            else img.classList.add('hidden');
            res.classList.remove('hidden'); no.classList.add('hidden');
        } else {
            res.classList.add('hidden'); no.classList.remove('hidden');
        }
    });

    window.clearData = () => { if(confirm("確定清空？")) { localStorage.removeItem('car_db_v2'); location.reload(); }};
    window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
    window.deleteCar = () => { carData = carData.filter(x => x.plate !== currentEditPlate); localStorage.setItem('car_db_v2', JSON.stringify(carData)); window.closeEditModal(); renderManage(); };
</script>
</body>
</html>
