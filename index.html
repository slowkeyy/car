<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½æˆ¶è»Šè™Ÿç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        * { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<div id="app" class="max-w-4xl mx-auto px-4 py-8 pb-24">
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-slate-800">ä½æˆ¶è»Šè™Ÿç®¡ç†ç³»çµ±</h1>
        <p class="text-slate-500 mt-2">å°ˆæ¥­ç®¡ç†ç‰ˆ (æ”¯æ´ç·¨è¼¯ã€ç…§ç‰‡èˆ‡æ¸¬é©—)</p>
    </header>

    <nav class="flex justify-center space-x-4 md:space-x-8 mb-8 border-b border-slate-200 overflow-x-auto hide-scrollbar whitespace-nowrap">
        <button onclick="window.switchTab('search')" id="tab-search" class="pb-2 px-2 md:px-4 font-medium transition-all tab-active">è»Šè™ŸæŸ¥è©¢</button>
        <button onclick="window.switchTab('quiz')" id="tab-quiz" class="pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500">éš¨æ©Ÿæ¸¬é©—</button>
        <button onclick="window.switchTab('manage')" id="tab-manage" class="pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500">è»Šè¼›ç®¡ç†</button>
        <button onclick="window.switchTab('data')" id="tab-data" class="pb-2 px-2 md:px-4 font-medium transition-all text-slate-500 hover:text-blue-500">è³‡æ–™å°å…¥</button>
    </nav>

    <!-- æœå°‹å€å¡Š -->
    <section id="section-search" class="space-y-6">
        <div class="glass-morphism p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="relative">
                <input type="text" id="search-input" placeholder="è¼¸å…¥è»Šè™Ÿæˆ–è»Šä½æœå°‹..." 
                    class="w-full pl-12 pr-4 py-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-lg shadow-inner">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>
        
        <div id="result-container" class="hidden animate-in fade-in duration-300">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-100">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-1 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 id="res-plate" class="text-4xl font-black text-blue-600 tracking-tight"></h2>
                            <span id="res-floor" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold uppercase"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xs text-slate-400 uppercase font-bold">å» ç‰Œ</p>
                                <p id="res-brand" class="text-xl font-semibold text-slate-700"></p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xs text-slate-400 uppercase font-bold">é¡è‰²</p>
                                <p id="res-color" class="text-xl font-semibold text-slate-700"></p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xs text-slate-400 uppercase font-bold">è»Šä½</p>
                                <p id="res-spot" class="text-xl font-semibold text-slate-700"></p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xs text-slate-400 uppercase font-bold">ä½æˆ¶ç·¨è™Ÿ</p>
                                <p id="res-id" class="text-xl font-semibold text-slate-700"></p>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-64 space-y-4">
                        <div id="photo-display" class="w-full aspect-square bg-slate-100 rounded-xl flex flex-col items-center justify-center border-2 border-dashed border-slate-200 overflow-hidden relative group">
                            <span class="text-slate-400 text-sm text-center px-4">å°šæœªä¸Šå‚³ç…§ç‰‡</span>
                            <img id="car-img" class="absolute inset-0 w-full h-full object-cover hidden">
                        </div>
                        <button onclick="window.openEditModalFromSearch()" class="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2 shadow-md">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                             </svg>
                             ç·¨è¼¯æ­¤è»Šè¼›è³‡è¨Š
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="no-result" class="hidden text-center py-12 text-slate-400 italic">æ‰¾ä¸åˆ°åŒ¹é…çš„è³‡æ–™ã€‚</div>
    </section>

    <!-- æ¸¬é©—å€å¡Š -->
    <section id="section-quiz" class="hidden space-y-6">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-100">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-slate-600">çœ‹åœ–/è»Šè™ŸçŒœè»Šä½</h3>
            </div>

            <div class="flex flex-col md:flex-row gap-6 mb-8 items-center">
                <div id="quiz-photo-box" class="w-full md:w-1/2 aspect-video bg-slate-100 rounded-2xl border border-slate-200 overflow-hidden flex items-center justify-center relative">
                    <img id="quiz-img" class="w-full h-full object-cover hidden">
                    <div id="quiz-img-placeholder" class="text-slate-300 flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>ç„¡ç…§ç‰‡æ•¸æ“š</span>
                    </div>
                </div>

                <div class="w-full md:w-1/2 space-y-4">
                    <div class="p-6 bg-blue-50 rounded-2xl border border-blue-100 text-center">
                        <p class="text-sm text-blue-400 font-bold uppercase mb-1">ç›®æ¨™è»Šç‰Œ</p>
                        <h2 id="quiz-plate" class="text-4xl font-black text-blue-700 tracking-wider">----</h2>
                        <div id="quiz-extra-info" class="mt-3 flex justify-center gap-2">
                            <span id="quiz-brand" class="px-2 py-1 bg-white text-slate-500 rounded text-xs border border-blue-100"></span>
                            <span id="quiz-color" class="px-2 py-1 bg-white text-slate-500 rounded text-xs border border-blue-100"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="quiz-options" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            
            <div id="quiz-feedback-box" class="mt-8 hidden">
                <div id="quiz-feedback" class="p-4 rounded-xl text-center font-bold text-lg mb-4"></div>
                <button onclick="window.generateQuiz()" class="w-full py-4 bg-slate-800 text-white rounded-xl hover:bg-slate-700 shadow-lg transition-all font-bold text-lg">
                    ä¸‹ä¸€é¡Œ
                </button>
            </div>
        </div>
    </section>

    <!-- è»Šè¼›ç®¡ç†å€å¡Š -->
    <section id="section-manage" class="hidden space-y-6">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">è»Šè¼›æ¸…å–® (<span id="manage-count">0</span>)</h3>
            <button onclick="window.openEditModal(null)" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition-colors">+ æ‰‹å‹•æ–°å¢è»Šè¼›</button>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase">ç…§ç‰‡</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase">è»Šè™Ÿ / è»Šä½</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase hidden md:table-cell">å» ç‰Œé¡è‰²</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="manage-list" class="divide-y divide-slate-50">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- è³‡æ–™å°å…¥ -->
    <section id="section-data" class="hidden space-y-6">
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100">
            <h3 class="text-xl font-bold mb-4">æ‰¹é‡å°å…¥</h3>
            <textarea id="raw-html-input" rows="8" class="w-full p-4 border border-slate-200 rounded-xl font-mono text-xs mb-4" placeholder="è²¼ä¸Š Notion HTML æˆ– ç´”æ–‡å­—æ•¸æ“š..."></textarea>
            <div class="flex gap-4">
                <button onclick="window.importDataFromHTML()" class="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md">å„²å­˜æ•¸æ“š</button>
                <button onclick="window.clearLocalData()" class="px-6 py-4 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 border border-red-200">æ¸…ç©º</button>
            </div>
            <div id="import-status" class="mt-4 text-center text-sm font-medium"></div>
        </div>
    </section>

    <!-- ç·¨è¼¯å½ˆçª— (Modal) -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm">
        <div class="bg-white p-6 md:p-8 rounded-2xl max-w-lg w-full shadow-2xl animate-in zoom-in duration-200 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">ç·¨è¼¯è»Šè¼›</h3>
                <button onclick="window.closeEditModal()" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-center mb-4">
                    <div id="modal-photo-preview" class="w-32 h-32 bg-slate-100 rounded-xl flex items-center justify-center border-2 border-dashed border-slate-200 overflow-hidden relative">
                        <span class="text-slate-300 text-[10px] text-center px-2">ç„¡ç…§ç‰‡</span>
                        <img id="modal-preview-img" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è»Šç‰Œè™Ÿç¢¼</label>
                        <input type="text" id="edit-plate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è»Šä½</label>
                        <input type="text" id="edit-spot" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">å» ç‰Œ</label>
                        <input type="text" id="edit-brand" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">é¡è‰²</label>
                        <input type="text" id="edit-color" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æ¨“å±¤</label>
                        <input type="text" id="edit-floor" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ä½æˆ¶ç·¨è™Ÿ</label>
                        <input type="text" id="edit-id" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ›´æ›ç…§ç‰‡</label>
                    <input type="file" accept="image/*" onchange="window.previewImage(event)" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div class="flex gap-4 pt-4">
                    <button id="delete-btn" onclick="window.deleteCurrentCar()" class="px-4 py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 border border-red-100 hidden">åˆªé™¤</button>
                    <button onclick="window.saveCarData()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸€èˆ¬è¨Šæ¯å½ˆçª— -->
    <div id="msg-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] px-4">
        <div class="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl text-center">
            <p id="msg-content" class="text-slate-700 font-medium"></p>
            <button onclick="window.closeModal()" class="mt-6 w-full py-2 bg-blue-600 text-white rounded-lg font-bold">ç¢ºå®š</button>
        </div>
    </div>
</div>

<script>
    let carData = JSON.parse(localStorage.getItem('local_car_db') || '[]');
    let currentEditPlate = null;
    let currentPreviewBase64 = null;

    // åˆ†é åˆ‡æ›
    window.switchTab = (tab) => {
        ['search', 'quiz', 'manage', 'data'].forEach(s => {
            const section = document.getElementById(`section-${s}`);
            const tabBtn = document.getElementById(`tab-${s}`);
            if (section) section.classList.add('hidden');
            if (tabBtn) {
                tabBtn.classList.remove('tab-active');
                tabBtn.classList.add('text-slate-500');
            }
        });
        document.getElementById(`section-${tab}`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).classList.add('tab-active');
        document.getElementById(`tab-${tab}`).classList.remove('text-slate-500');
        
        if(tab === 'quiz') window.generateQuiz();
        if(tab === 'manage') window.renderManageList();
    };

    window.closeModal = () => document.getElementById('msg-modal').classList.add('hidden');
    function showMsg(t) {
        document.getElementById('msg-content').innerText = t;
        document.getElementById('msg-modal').classList.remove('hidden');
    }

    // æœå°‹åŠŸèƒ½
    document.getElementById('search-input').addEventListener('input', (e) => {
        const val = e.target.value.toUpperCase().trim();
        const container = document.getElementById('result-container');
        const noRes = document.getElementById('no-result');
        if (!val) { container.classList.add('hidden'); noRes.classList.add('hidden'); return; }
        
        const found = carData.find(c => c.plate.includes(val) || (c.spot && c.spot.includes(val)));
        if (found) {
            document.getElementById('res-plate').innerText = found.plate;
            document.getElementById('res-brand').innerText = found.brand || '---';
            document.getElementById('res-color').innerText = found.color || '---';
            document.getElementById('res-spot').innerText = found.spot || '---';
            document.getElementById('res-floor').innerText = found.floor || '---';
            document.getElementById('res-id').innerText = found.id || '---';
            const img = document.getElementById('car-img');
            const placeholder = document.querySelector('#photo-display span');
            if (found.photoBase64) {
                img.src = found.photoBase64; img.classList.remove('hidden'); placeholder.classList.add('hidden');
            } else {
                img.classList.add('hidden'); placeholder.classList.remove('hidden');
            }
            container.classList.remove('hidden'); noRes.classList.add('hidden');
        } else {
            container.classList.add('hidden'); noRes.classList.remove('hidden');
        }
    });

    // --- ç®¡ç†èˆ‡ç·¨è¼¯é‚è¼¯ ---

    window.openEditModalFromSearch = () => {
        const plate = document.getElementById('res-plate').innerText;
        window.openEditModal(plate);
    };

    window.openEditModal = (plate = null) => {
        const modal = document.getElementById('edit-modal');
        const title = document.getElementById('modal-title');
        const delBtn = document.getElementById('delete-btn');
        currentEditPlate = plate;
        currentPreviewBase64 = null;

        if (plate) {
            const car = carData.find(c => c.plate === plate);
            title.innerText = "ç·¨è¼¯è»Šè¼›è³‡è¨Š";
            delBtn.classList.remove('hidden');
            document.getElementById('edit-plate').value = car.plate;
            document.getElementById('edit-spot').value = car.spot || '';
            document.getElementById('edit-brand').value = car.brand || '';
            document.getElementById('edit-color').value = car.color || '';
            document.getElementById('edit-floor').value = car.floor || '';
            document.getElementById('edit-id').value = car.id || '';
            
            const pImg = document.getElementById('modal-preview-img');
            const pSpan = document.querySelector('#modal-photo-preview span');
            if (car.photoBase64) {
                pImg.src = car.photoBase64; pImg.classList.remove('hidden'); pSpan.classList.add('hidden');
                currentPreviewBase64 = car.photoBase64;
            } else {
                pImg.classList.add('hidden'); pSpan.classList.remove('hidden');
            }
        } else {
            title.innerText = "æ–°å¢è»Šè¼›";
            delBtn.classList.add('hidden');
            ['edit-plate','edit-spot','edit-brand','edit-color','edit-floor','edit-id'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('modal-preview-img').classList.add('hidden');
            document.querySelector('#modal-photo-preview span').classList.remove('hidden');
        }
        modal.classList.remove('hidden');
    };

    window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

    window.previewImage = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            currentPreviewBase64 = e.target.result;
            const pImg = document.getElementById('modal-preview-img');
            const pSpan = document.querySelector('#modal-photo-preview span');
            pImg.src = currentPreviewBase64;
            pImg.classList.remove('hidden');
            pSpan.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    };

    window.saveCarData = () => {
        const plate = document.getElementById('edit-plate').value.trim().toUpperCase();
        if (!plate) { showMsg("è«‹è¼¸å…¥è»Šç‰Œï¼"); return; }

        const newData = {
            id: document.getElementById('edit-id').value.trim(),
            plate: plate,
            brand: document.getElementById('edit-brand').value.trim(),
            color: document.getElementById('edit-color').value.trim(),
            floor: document.getElementById('edit-floor').value.trim(),
            spot: document.getElementById('edit-spot').value.trim(),
            photoBase64: currentPreviewBase64
        };

        if (currentEditPlate) {
            const idx = carData.findIndex(c => c.plate === currentEditPlate);
            carData[idx] = newData;
        } else {
            if (carData.some(c => c.plate === plate)) { showMsg("æ­¤è»Šç‰Œå·²å­˜åœ¨ï¼"); return; }
            carData.push(newData);
        }

        localStorage.setItem('local_car_db', JSON.stringify(carData));
        window.closeEditModal();
        window.renderManageList();
        showMsg("å„²å­˜æˆåŠŸï¼");
        // æ›´æ–°ç•¶å‰æœå°‹è¦–çª— (å¦‚æœåœ¨æœå°‹é )
        document.getElementById('search-input').dispatchEvent(new Event('input'));
    };

    window.deleteCurrentCar = () => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
        carData = carData.filter(c => c.plate !== currentEditPlate);
        localStorage.setItem('local_car_db', JSON.stringify(carData));
        window.closeEditModal();
        window.renderManageList();
        document.getElementById('search-input').value = "";
        document.getElementById('result-container').classList.add('hidden');
    };

    window.renderManageList = () => {
        const list = document.getElementById('manage-list');
        const count = document.getElementById('manage-count');
        count.innerText = carData.length;
        list.innerHTML = "";

        // ç°¡å–®æ’åºï¼šæŒ‰è»Šä½
        const sorted = [...carData].sort((a,b) => (a.spot || "").localeCompare(b.spot || ""));

        sorted.forEach(car => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors group";
            tr.innerHTML = `
                <td class="p-4">
                    <div class="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden border border-slate-200">
                        ${car.photoBase64 ? `<img src="${car.photoBase64}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] text-slate-300">NO</div>`}
                    </div>
                </td>
                <td class="p-4">
                    <div class="font-bold text-slate-800">${car.plate}</div>
                    <div class="text-xs text-blue-500 font-medium">${car.spot || 'ç„¡è»Šä½'}</div>
                </td>
                <td class="p-4 hidden md:table-cell">
                    <div class="text-sm text-slate-600">${car.brand || '-'}</div>
                    <div class="text-xs text-slate-400">${car.color || '-'}</div>
                </td>
                <td class="p-4 text-right">
                    <button onclick="window.openEditModal('${car.plate}')" class="p-2 text-slate-400 hover:text-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </td>
            `;
            list.appendChild(tr);
        });
    };

    // --- æ¸¬é©—èˆ‡å°å…¥ (ä¿æŒåŸæœ‰é‚è¼¯) ---

    window.generateQuiz = () => {
        const optionsContainer = document.getElementById('quiz-options');
        const feedbackBox = document.getElementById('quiz-feedback-box');
        feedbackBox.classList.add('hidden');
        if (carData.length < 4) { optionsContainer.innerHTML = "è³‡æ–™ä¸è¶³ 4 ç­†ï¼Œç„¡æ³•é–‹å§‹æ¸¬é©—ã€‚"; return; }

        const correct = carData[Math.floor(Math.random() * carData.length)];
        document.getElementById('quiz-plate').innerText = correct.plate;
        document.getElementById('quiz-brand').innerText = correct.brand || 'æœªçŸ¥å“ç‰Œ';
        document.getElementById('quiz-color').innerText = correct.color || 'æœªçŸ¥é¡è‰²';
        
        const qImg = document.getElementById('quiz-img');
        const qImgPlaceholder = document.getElementById('quiz-img-placeholder');
        if (correct.photoBase64) {
            qImg.src = correct.photoBase64; qImg.classList.remove('hidden'); qImgPlaceholder.classList.add('hidden');
        } else {
            qImg.classList.add('hidden'); qImgPlaceholder.classList.remove('hidden');
        }

        let opts = [correct.spot];
        while (opts.length < 4) {
            const r = carData[Math.floor(Math.random() * carData.length)].spot;
            if (r && !opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        optionsContainer.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = "p-4 bg-white border-2 border-slate-100 rounded-xl font-bold text-lg hover:border-blue-500 transition-all";
            b.innerText = o;
            b.onclick = () => {
                optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
                feedbackBox.classList.remove('hidden');
                const fb = document.getElementById('quiz-feedback');
                if (o === correct.spot) {
                    fb.innerText = "ğŸ‰ å¤ªå¼·äº†ï¼ç­”å°äº†ï¼"; fb.className = "p-4 rounded-xl text-center font-bold bg-emerald-100 text-emerald-700 mb-4";
                    b.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                } else {
                    fb.innerText = `âŒ å“å‘€ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correct.spot}`; fb.className = "p-4 rounded-xl text-center font-bold bg-red-100 text-red-700 mb-4";
                    b.classList.add('bg-red-500', 'text-white', 'border-red-500');
                }
            };
            optionsContainer.appendChild(b);
        });
    };

    window.importDataFromHTML = () => {
        const input = document.getElementById('raw-html-input').value.trim();
        const status = document.getElementById('import-status');
        if(!input) return;
        try {
            let newBatch = [];
            if (input.includes("<tr")) {
                const parser = new DOMParser();
                const docObj = parser.parseFromString(input, 'text/html');
                const rows = docObj.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        const plate = cells[1].innerText.trim();
                        if (plate && plate !== "è»Šè™Ÿ" && plate !== "è»Šç‰Œ") {
                            newBatch.push({ id: cells[0].innerText.trim(), plate: plate, brand: cells[2].innerText.trim(), color: cells[3].innerText.trim(), floor: cells[4].innerText.trim(), spot: cells[5].innerText.trim(), photoBase64: null });
                        }
                    }
                });
            } else {
                const lines = input.split('\n').map(l => l.trim()).filter(l => l !== "");
                for (let i = 0; i < lines.length; ) {
                    if (!isNaN(lines[i]) && lines[i+1] && lines[i+1].includes('-')) {
                        newBatch.push({ id: lines[i], plate: lines[i+1], brand: lines[i+2], color: lines[i+3], floor: lines[i+4], spot: lines[i+5], photoBase64: null });
                        i += 7;
                    } else { i++; }
                }
            }
            if (newBatch.length === 0) throw new Error("è§£æå¤±æ•—");
            newBatch = newBatch.map(n => {
                const old = carData.find(o => o.plate === n.plate);
                if (old && old.photoBase64) n.photoBase64 = old.photoBase64;
                return n;
            });
            carData = newBatch;
            localStorage.setItem('local_car_db', JSON.stringify(carData));
            status.innerText = `æˆåŠŸå°å…¥ ${carData.length} ç­†ã€‚`;
            status.className = "mt-4 text-emerald-600 font-bold";
        } catch (e) {
            status.innerText = "å°å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚";
            status.className = "mt-4 text-red-600 font-bold";
        }
    };

    window.clearLocalData = () => { if(confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰æœ¬åœ°æ•¸æ“šï¼Ÿ")) { localStorage.removeItem('local_car_db'); location.reload(); }};
</script>
</body>
</html>
